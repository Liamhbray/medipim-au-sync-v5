name: MediPim Product Sync

on:
  schedule:
    # Run daily at 2 AM Sydney time (4 PM UTC during DST, 3 PM UTC standard time)
    - cron: '0 16 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      force:
        description: 'Force sync even if one is running'
        required: false
        default: 'false'

jobs:
  sync:
    name: Sync MediPim Products
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Trigger Sync
        id: sync
        run: |
          echo "Starting MediPim sync at $(date)"
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://medipim-orchestrator.fly.dev/sync \
            -H "X-ADMIN-KEY: ${{ secrets.MEDIPIM_ADMIN_KEY }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -ne 200 ]; then
            echo "::error::Sync failed with status code $http_code"
            exit 1
          fi
          
          echo "sync_response=$body" >> $GITHUB_OUTPUT
      
      - name: Monitor Sync Progress
        run: |
          echo "Monitoring sync progress..."
          
          # Wait for sync to complete (check every 30 seconds)
          max_attempts=120  # 60 minutes max
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            sleep 30
            
            status=$(curl -s https://medipim-orchestrator.fly.dev/status \
              -H "X-ADMIN-KEY: ${{ secrets.MEDIPIM_ADMIN_KEY }}" | jq -r '.currentPhase')
            
            echo "$(date): Status = $status"
            
            if [ "$status" = "completed" ]; then
              echo "âœ… Sync completed successfully!"
              
              # Get final statistics
              curl -s https://medipim-orchestrator.fly.dev/status \
                -H "X-ADMIN-KEY: ${{ secrets.MEDIPIM_ADMIN_KEY }}" | jq '.progress'
              
              exit 0
            elif [ "$status" = "failed" ]; then
              echo "::error::Sync failed!"
              
              # Get error details
              curl -s https://medipim-orchestrator.fly.dev/status \
                -H "X-ADMIN-KEY: ${{ secrets.MEDIPIM_ADMIN_KEY }}" | jq '.errors'
              
              exit 1
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "::error::Sync timed out after 60 minutes"
          exit 1
      
      - name: Send Notification on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Create an issue if sync fails
            const title = `MediPim Sync Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `The automated MediPim sync has failed.
            
            **Workflow Run**: [${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Time**: ${new Date().toISOString()}
            
            Please check the logs and investigate the issue.`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'sync-failure']
            });